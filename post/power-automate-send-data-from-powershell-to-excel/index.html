<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Get Data from workstations and send to an Excel Table for free ::
        David Just — A technology website
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Premise There are times when I encounter a situation where I want to gather some data from workstations and store it in a spreadsheet / table ect. for tracking purposes. Recently I was working with a client to deploy a cloud printing solution. The on prem print environment was somewhat complex with multiple shared printers some of which were locked down to AD security groups. I needed a way to get a pre-deployment printer inventory for each workstation, then compare a post deployment inventory."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/power-automate-send-data-from-powershell-to-excel/" />




<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Page(\/post\/Power-Automate-Send-Data-From-PowerShell-To-Excel\/index.md)', 'auto');
ga('send', 'pageview');

</script>




<link rel="stylesheet" href="/assets/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Get Data from workstations and send to an Excel Table for free"/>
<meta name="twitter:description" content="Premise There are times when I encounter a situation where I want to gather some data from workstations and store it in a spreadsheet / table ect. for tracking purposes. Recently I was working with a client to deploy a cloud printing solution. The on prem print environment was somewhat complex with multiple shared printers some of which were locked down to AD security groups. I needed a way to get a pre-deployment printer inventory for each workstation, then compare a post deployment inventory."/>



<meta property="og:title" content="Get Data from workstations and send to an Excel Table for free" />
<meta property="og:description" content="Premise There are times when I encounter a situation where I want to gather some data from workstations and store it in a spreadsheet / table ect. for tracking purposes. Recently I was working with a client to deploy a cloud printing solution. The on prem print environment was somewhat complex with multiple shared printers some of which were locked down to AD security groups. I needed a way to get a pre-deployment printer inventory for each workstation, then compare a post deployment inventory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/power-automate-send-data-from-powershell-to-excel/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-03T00:00:00+00:00" /><meta property="og:site_name" content="David Just" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark">PS C:\Users\Dave></span>
    <span class="logo__text">Invoke-Blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
            
          <li><a href="/about">About <img src=""/> 
          </a></li>        
          
        
      
            
          <li><a href="https://github.com/djust270">My Github <img src=""/> 
          </a></li>        
          
        
      
            
          <li><a href="/index.xml"> <img src="/rss%20%28Custom%29.png"/> 
          </a></li>        
          
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="https://github.com/djust270">My Github</a></li>
      
    
      
        <li><a href="/index.xml"></a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Get Data from workstations and send to an Excel Table for free</h1>
    <div class="post-meta">
      
        <span class="post-date">      
          May 3, 2022
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by David Just</span
        >


      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/o365/">#O365</a>&nbsp;
        
          <a href="/tags/intune/">#Intune</a>&nbsp;
        
          <a href="/tags/power-automate/">#Power Automate</a>&nbsp;
        
          <a href="/tags/microsoft-graph/">#Microsoft Graph</a>&nbsp;
        
      </span>
    

    
      <figure class="post-cover">
  
    <img src="/post/power-automate-send-data-from-powershell-to-excel/powerautomate.png" alt="Get Data from workstations and send to an Excel Table for free"/>
  

  
</figure>

    

    <div class="post-content">
      
      <h3 id="premise">Premise <a href="#premise">
  <svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg" fill= #01F9C6>
  <path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
  
</svg>
</a></h3>

<p>There are times when I encounter a situation where I want to gather some data from workstations and store it in a spreadsheet / table ect. for tracking purposes. 
Recently I was working with a client to deploy a cloud printing solution. The on prem print environment was somewhat complex with multiple shared printers some of which were
locked down to AD security groups. I needed a way to get a pre-deployment printer inventory for each workstation, then compare a post deployment inventory. In came PowerAutomate and PowerShell.</p>
<p>In a previous article, I covered how to use Power Automate to shuttle data from a workstation/server into an Azure Table using Power Automate and the HTTP request trigger.
This method is straight forward, easy, and works great but has a catch. The HTTP trigger is a premium feature which requires a $15/MONTH license. How can we accomplish
the same result more or less completely for free? This article will explain the method I came up with using PowerShell, the Microsoft Graph and Power Automate.</p>
<h3 id="getting-a-list-of-printers">Getting a list of printers <a href="#getting-a-list-of-printers">
  <svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg" fill= #01F9C6>
  <path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
  
</svg>
</a></h3>

<p>Getting a list of printers from each workstation is fairly straight forward using PowerShell.</p>
<ul>
<li>Use the <code>Get-Printer</code> cmdlet on each workstation to get a list of printers. Filter for only shared printers.</li>
<li>Run the script as the logged on user, so we get the user connections.</li>
<li>Move the results off the workstation to a central repository.</li>
</ul>
<p>Lets put it together. First getting the list of printers :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#75715e"># Get list of installed shared printers</span>
</span></span><span style="display:flex;"><span>$printers = Get-Printer | where type <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;Connection&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$printerList = <span style="color:#66d9ef">foreach</span> ($printer <span style="color:#66d9ef">in</span> $printers){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[pscustomobject]</span>@{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ComputerName&#39;</span> = hostname   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PrinterName&#39;</span> = $printer.name
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PrinterPortname&#39;</span> = $printer.portname
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Type&#39;</span> = $printer.type
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$printerJSON = $printerList | ConvertTo-JSON
</span></span></code></pre></div><h3 id="setting-up-the-framework-to-send-email-using-graph">Setting up the framework to send email using Graph <a href="#setting-up-the-framework-to-send-email-using-graph">
  <svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg" fill= #01F9C6>
  <path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
  
</svg>
</a></h3>

<p>Alright now how can we get this data into table and trigger a PowerAutomate flow for free? Send Mail with Microsoft graph. <a href="https://practical365.com/send-mail-exchange-online-graph-powershell/" target="_blank">
    Practical 365 has a great article on how to send email with Microsoft Graph using PowerShell
  </a> 
This consits of 3 steps</p>
<ul>
<li>Create an App registration in AzureAD</li>
<li>Give the app registration mail.send application rights.</li>
<li>Create an application secret to use for Authentication.</li>
</ul>
<ol>
<li>Head over to the <a href="aad.portal.azure.com">
    Azure AD Portal
  </a></li>
<li>Click on Azure Active Directory, then App Registrations</li>
<li>Click new registration. Give the app a descriptive name</li>
</ol>

  <img src="./registerapp.png"  class="center"  style="border-radius: 8px;"  />


<ol start="4">
<li>Under &lsquo;API Permissions&rsquo; click app permission. Under Microsoft Graph, Select the application permission &lsquo;Mail.Send&rsquo;</li>
</ol>

  <img src="./mailsend.png"  class="center"  style="border-radius: 8px;"  />


<ol start="5">
<li>Grant Admin Consent.</li>
<li>Create an app secret
<ul>
<li>Go to &lsquo;Certificate and Secrets&rsquo;</li>
<li>Click &lsquo;New Client Secret&rsquo;</li>
<li>(Optional) Enter a description.</li>
<li>Copy down the secret value for later</li>
</ul>
</li>
<li>Go to overview, copy down the tenant ID and app ID for later.</li>
</ol>
<p>Once we have the app created, we need to prepare exchange:</p>
<ul>
<li>Create a shared mailbox for our sending mail account</li>
<li>Create an application policy to restrict our app from sending as any mailbox other than our service account</li>
</ul>
<p>We can easily do this in PowerShell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$mailsender = <span style="color:#66d9ef">[mailaddress]</span><span style="color:#e6db74">&#39;flowservice@justgeeks.co&#39;</span>
</span></span><span style="display:flex;"><span>$appID = <span style="color:#e6db74">&#39;APP ID you copied down before&#39;</span>
</span></span><span style="display:flex;"><span>New-Mailbox -Shared -Name $mailsender.user -DisplayName $mailsender.user -Alias $mailsender.user -PrimarySmtpAddress $mailsender.address
</span></span><span style="display:flex;"><span>New-ApplicationAccessPolicy -AccessRight RestrictAccess -AppId $AppID -PolicyScopeGroupId $mailsender.address -Description <span style="color:#e6db74">&#34;Restrict this app&#39;s access to flow service account&#34;</span>
</span></span></code></pre></div><h3 id="send-data-from-each-workstation-via-email">Send data from each workstation via email <a href="#send-data-from-each-workstation-via-email">
  <svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg" fill= #01F9C6>
  <path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
  
</svg>
</a></h3>

<p>Now that we have a way to send email with the Microsoft Graph, we can craft a PowerShell script to run per workstation to send the data we want via email.
We will take the PowerShell snippet from before to get the list of printers. Then add the steps to send an email with graph and attach the list of printers as an attachment in the email.
This way we can parse the attachment later for the data we want to store.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#75715e"># List of printers</span>
</span></span><span style="display:flex;"><span>$printers = Get-Printer | where type <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;Connection&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$printerList = <span style="color:#66d9ef">foreach</span> ($printer <span style="color:#66d9ef">in</span> $printers){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[pscustomobject]</span>@{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ComputerName&#39;</span> = $env:COMPUTERNAME   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PrinterName&#39;</span> = $printer.name
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PrinterPortname&#39;</span> = $printer.portname
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Type&#39;</span> = $printer.type
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert list to JSON to later parse in PowerAutomate</span>
</span></span><span style="display:flex;"><span>$json = $printerList | ConvertTo-JSON
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Azure App Registration Variables</span>
</span></span><span style="display:flex;"><span>$clientID = <span style="color:#e6db74">&#34;125d565f-df97-437a-a5fa-1e119a359a8d&#34;</span>
</span></span><span style="display:flex;"><span>$Clientsecret = <span style="color:#e6db74">&#34;4e5b5d~lkjjio98LyOOE94i_56daskjllk&#34;</span>
</span></span><span style="display:flex;"><span>$tenantID = <span style="color:#e6db74">&#34;c7d54f65-0023-4525-a44e-eed2653923ae&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mail details</span>
</span></span><span style="display:flex;"><span>$from = <span style="color:#e6db74">&#34;flowservice@davidjust.com&#34;</span>
</span></span><span style="display:flex;"><span>$to = <span style="color:#e6db74">&#34;david@davidjust.com&#34;</span>
</span></span><span style="display:flex;"><span>$subject = <span style="color:#e6db74">&#34;PrinterResults&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Get an auth token for the GRAPH API using the app registration</span>
</span></span><span style="display:flex;"><span>$tokenBody = @{
</span></span><span style="display:flex;"><span>    Grant_Type    = <span style="color:#e6db74">&#34;client_credentials&#34;</span>
</span></span><span style="display:flex;"><span>    Scope         = <span style="color:#e6db74">&#34;https://graph.microsoft.com/.default&#34;</span>
</span></span><span style="display:flex;"><span>    Client_Id     = $clientId
</span></span><span style="display:flex;"><span>    Client_Secret = $clientSecret
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$tokenResponse = Invoke-RestMethod -Uri <span style="color:#e6db74">&#34;https://login.microsoftonline.com/$tenantID/oauth2/v2.0/token&#34;</span> -Method POST -Body $tokenBody
</span></span><span style="display:flex;"><span>$headers = @{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Authorization&#34;</span> = <span style="color:#e6db74">&#34;Bearer </span>$($tokenResponse.access_token)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Content-type&#34;</span>  = <span style="color:#e6db74">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>$URL = <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users/$from/sendMail&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$bytes = <span style="color:#66d9ef">[System.Text.Encoding]</span>::UTF8.GetBytes($json)
</span></span><span style="display:flex;"><span>$base64 = <span style="color:#66d9ef">[System.Convert]</span>::ToBase64String($bytes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Craft the JSON POST Body</span>
</span></span><span style="display:flex;"><span>$body = <span style="color:#e6db74">@&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;message&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;subject&#34;: &#34;$subject&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;body&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;contentType&#34;: &#34;Text&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;content&#34;: &#34;Results&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;toRecipients&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;emailAddress&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          &#34;address&#34;: &#34;$to&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;attachments&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;@odata.type&#34;: &#34;#microsoft.graph.fileAttachment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;name&#34;: &#34;json.txt&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;contentBytes&#34;: &#34;$base64&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Finally, send the email using Graph</span>
</span></span><span style="display:flex;"><span>Invoke-RestMethod -Method POST -Uri $URL -Headers $headers -Body $Body
</span></span></code></pre></div><h3 id="power-automate-flow">Power Automate Flow <a href="#power-automate-flow">
  <svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg" fill= #01F9C6>
  <path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
  
</svg>
</a></h3>

<p>Now we have framework from which to send emails through the Microsoft Graph. Now lets move on to creating our Power Automate Flow.</p>
<ul>
<li>Before adding creating our PowerAutomate flow, we need to prepare an excel workbook to store results
<ul>
<li>Go to portal.office.com and create a blank excel workbook.</li>
<li>Click insert, table, check my table has headers. Click OK</li>
<li>Add additional columns and edit each column with the property names you wish to store in the table</li>
<li>Click File, SaveAs, then rename the workbook and change the location if you wish.</li>
</ul>
</li>
</ul>

  <img src="./flow3.png"  class="center"  style="border-radius: 8px;"  />


<ul>
<li>Login to <a href="https://flow.microsoft.com" target="_blank">
    https://flow.microsoft.com
  </a>.</li>
<li>Created an automated flow with the trigger &ldquo;O365 When a new email arrives v3&rdquo;. Enter a name and click create.</li>
</ul>

  <img src="./flow1.png"  class="center"  style="border-radius: 8px;"  />


<ul>
<li>Expand advanced. Enter the flow service email address in the from field and enter the subject of incoming emails to capture. Select only with attachments. 
Click new step.</li>
</ul>

  <img src="./flow2.png"  class="center"  style="border-radius: 8px;"  />


<ul>
<li>
<p>Search for &ldquo;Get Attachment (V2)&rdquo;</p>
<ul>
<li>Under Message ID, select the dynamic content &ldquo;Message ID&rdquo; from our previous step</li>
<li>For attachment ID, select &ldquo;Attachments Attachment ID&rdquo;. This will automatically create an apply to each step.</li>
<li>Click add an action for the next step</li>
</ul>

  <img src="./flow4.png"  class="center"  style="border-radius: 8px;"  />


</li>
<li>
<p>Search for &ldquo;Compose&rdquo;. Here we need to enter an expression for inputs. Select expression, then type <code>decodeBase64()</code>. Click inside the parantheses and under dynamic content, select the dynamic &ldquo;Content Bytes&rdquo; to add the content of the attachment. The full expression should look like this <code>decodeBase64(outputs('Get_Attachment_(V2)')?['body/contentBytes'])</code>
Click add action.</p>
</li>
</ul>

  <img src="./flow5.png"  class="center"  style="border-radius: 8px;"  />


<ul>
<li>Search for &ldquo;Parse JSON&rdquo;
<ul>
<li>In content, select the dynamic content &ldquo;Outputs&rdquo; from the compose action.</li>
<li>For schema, we can simply generate from sample. Open PowerShell, and paste the code for the data we want to generate. Pipe to <code>ConvertTo-JSON</code> to generate a JSON object. Paste the output into the sample field</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$printers = 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($printer <span style="color:#66d9ef">in</span> (get-printer)){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[pscustomobject]</span>@{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ComputerName&#39;</span> = $env:COMPUTERNAME   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PrinterName&#39;</span> = $printer.name
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PrinterPortname&#39;</span> = $printer.portname
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Type&#39;</span> = $printer.type
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>$printers | ConvertTO-JSON 
</span></span></code></pre></div>
  <img src="./flow6.png"  class="center"  style="border-radius: 8px;"  />


<ul>
<li>
<p>Next add one more action in under apply to each. Search for the action &ldquo;Add a row into a table (Excel Online)&rdquo;</p>
<ul>
<li>Fill in the fields for location picking the excel workbook you prepared earlier.</li>
<li>For the table fields, select the dynamic content from the parse JSON action.</li>
</ul>
</li>
</ul>

  <img src="./flow7.png"  class="center"  style="border-radius: 8px;"  />


<ul>
<li>For the final step, add a new step. Search for &ldquo;Delete an email (v2)&rdquo;. Add the dynamic content</li>
</ul>
<p>No save the flow. Go ahead and test the entire PowerShell script. You should see a sucessful run. You can even see the excel table being filled in real time!</p>

  <img src="./tablefill.gif"  class="center"  style="border-radius: 8px;"  />


<h3 id="final-thoughts">Final thoughts <a href="#final-thoughts">
  <svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg" fill= #01F9C6>
  <path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
  
</svg>
</a></h3>

<p>While this isnt the most straight forward or simpllist solution, you cant beat free. I do not like the idea of storing secrets inside scripts, but you can mitigate any risk of misuse by creating the application policy as shown in exchange. Also, when you are done with your script deployment, simply delete the secret inside the app registration. Create a new secret each time you wish to run this flow. If you have any suggestions for improving this flow or another way of doing similar, please let me know!</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/post/working-with-microsoft-graph-powershell-sdk/">
                  <span class="button__text">Working with the Microsoft Graph PowerShell SDK</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "davidjust" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      
    
  </div>
  


      </div>

      
        <footer class="footer">
  davidjust.com © 2022     
  <div class="footer__inner">    
  </div>
  <div class="footer__right">     
    
    <a href="mailto:david@davidjust.com" target="_blank" rel="noopener noreferrer me" title="email">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2"
width="40" height="40"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
    <polyline points="22,6 12,13 2,6"></polyline>    
</svg>   
    </a>     
    
    <a href="https://twitter.com/DavidJu14353759" target="_blank" rel="noopener noreferrer me" title="twitter">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
width="40" height="40"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>   
    </a>     
     
  </div>     
</footer>
<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

    <script src="/assets/clipboard.js" ></script>



      
    </div>

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WELHH4HTZ7"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-WELHH4HTZ7', { 'anonymize_ip': false });
}
</script>

    
  </body>
</html>
